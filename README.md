 # **Необычные датчики и график для ESP8266 с датчиком BME280**
 
 https://www.instructables.com/id/ESP8266-NodeMCU-With-BME280-Gauges-Chart/
 
 ![Скриншот](https://github.com/optio50/ESP8266-NodeMCU-12E-with-BME280/blob/master/1%20Week%20Chart.png?raw=true "График за 1 неделю")
 

 Необычные датчики и схема для вашей платы разработки ESP8266 NodeMCU с датчиком температуры, влажности и давления BME280. Thingspeak будет хранить все ваши данные в облаке для извлечения в любое время в течение многих лет (надеюсь). Датчики и диаграмма заполняются на основе данных, хранящихся в thingspeak, и обновляются автоматически каждые 5 минут.

## Необходимые товары:

Плата для разработки ESP8266 NodeMCU ($ 3,79 от Banggood.com Гонконг)

Bosch BME280 ($ 5,63 от Banggood.com Гонконг)

Перемычки для макетной платы ($ 3,09 от Banggood.com Гонконг)

Макетная плата ($ 2,28 от Banggood.com Гонконг)

Блок питания, бесплатно, если у вас есть зарядное устройство для телефона micro USB

Кабель Micro USB, бесплатно, если он у вас уже есть

### Arduino IDE, скачать бесплатно


1. Создайте бесплатную учетную запись Thingspeak и новый канал по адресу https://thingspeak.com, Назовите канал "ESP8266-NodeMCU-12E-BME280".

2. В новом канале должно быть 3 поля с именами Температура, влажность, давление в определенном порядке (обратите внимание на первую букву заглавными буквами).

3. Обратите внимание на ваш новый "идентификатор канала" XXXXXX в разделе "Настройки канала".

4. Нажмите на ссылку "Ключи API" и обратите внимание на ваши "Запись в API" и "Чтение ключей API" XXXXXXXXXXXXXXX. Также сделайте этот канал общедоступным в разделе "Общий доступ".

5. Создайте второй канал Thingspeak, который будет содержать "Сегодня" (с полуночи) Данные о высоком минимуме. Назовите это "Данные о высоком минимуме BME280 за день".

6. Этот новый канал должен содержать 6 полей с именами Tmax, Tmin, Hmax, Hmin, Pmax, Pmin в этом определенном порядке (обратите внимание на первую букву заглавными буквами).

7. Обратите внимание на "Данные BME280 Daily High Low Data", "идентификатор канала", "Чтение" и "Запись ключей API", как в описанных выше шагах.

8. Следуйте инструкциям по установке Arduino IDE и ядра ESP8266 по адресу http://easy-esp.com/getting-started-with-easyesp-...

9. Запустите Arduino IDE, чтобы мы могли установить четыре необходимые нам библиотеки.

10. Вам понадобится библиотека "Adafruit Unified Sensor Driver", установите ее в "Диспетчере библиотек" в Arduino IDE. Эскиз меню -> Включить библиотеку -> Управление библиотеками выполните поиск по типу = "Рекомендуемая" тема = "Датчики", затем введите слова Adafruit Unified Sensor Driver в поле поиска. Тот, который вам нужен, гласит "Adafruit Unified Sensor Driver от Adafruit".

11. Кроме того, вам также потребуется "Библиотека Adafruit BME280", установите ее в "Менеджер библиотек" в Arduino IDE. Эскиз меню -> Включить библиотеку -> Управление библиотеками выполните поиск по типу = "Рекомендуемая" тема = "Датчики", затем введите слова Adafruit BME280 Library в поле поиска. На той, которая вам нужна, написано "Библиотека Adafruit BME280 от Adafruit"

12. Еще одна нужная вам библиотека - Wire.h , установите ее в "Диспетчере библиотек" в Arduino IDE. Меню, Эскиз -> Включить библиотеку -> Управление библиотеками Выполните поиск по типу = "Внесенный вклад" Тема = "Ввод / вывод сигнала", затем введите слово Wire в поле поиска. Тот, который вам нужен, говорит "Встроенный провод от Arduino", скорее всего, в нижней части выбора.

13. Еще одна библиотека, ESP8266WiFi, установите ее в "Менеджер библиотек" в Arduino IDE. Меню, Эскиз -> Включить библиотеку -> Управление библиотеками Выполните поиск по типу = "Внесенный вклад" Тема = "Общение" затем введите слово ESP8266WiFi в поле поиска. На том, который вам нужен, написано "Встроенный ESP8266WiFi от Ивана Грохоткова".

14. Адрес I2C для BME280 жестко задан в файле Adafruit_BME280.h (найдите строку #define BME280_ADDRESS 0x77) внутри папки Adafruit_BME280_Library. Модули датчиков BME Adafruit жестко подключены для использования адреса I2C 0x77. Но BME280 может иметь немного другой адрес I2C (0x76), если его внешний вывод SDO заземлен. Если вы используете сенсорные модули сторонних производителей, вполне вероятно, что их адрес не будет совпадать со значением по умолчанию в библиотеке Adafruit. Например, для большинства сенсорных модулей BME280, доступных на eBay или Aliexpress, их адрес I2C равен 0x76. Если вы не получаете ответа от датчика, используя адрес по умолчанию, установленный в файле Adafruit_BME280.h, возможно, вам потребуется изменить его на 0x76.

Точки подключения BME280 и ESP8266. ESP8266 3,3В к BME280 Vin, ESP8266 GND к BME280 GND, ESP8266 D4 к BME280 SCL, ESP8266 D3 к BME280 SDA. 15. Откройте прилагаемый ESP8266-NodeMCU-12E-BME280.html создайте файл в текстовом редакторе и введите свой "ESP8266-NodeMCU-12E-BME280" (первый созданный вами канал), "Идентификатор канала" и "Ключ чтения API" для переменных key1 и chan1. Также введите "Read API Key" и "Channel ID" для "BME280 Daily High Low Data" (второй созданный вами канал) для key2 и chan2. Кроме того, введите смещение вашего часового пояса от UTC. Для меня это значение равно -5. Все значения должны быть заключены в предоставленные одинарные кавычки 'XXXXX'. Сохраните и выйдите из текстового редактора.

15. Подключите устройство ESP8266 с помощью USB-кабеля к компьютеру, затем выберите последовательный порт в качестве USB-порта.

Пользователям Linux, возможно, придется изменить собственное управление USB-портом для связи с / dev / ttyUSB0, как в 'sudo chown yourusername / dev / ttyUSB0' или с тем, что вы когда-либо выбирали в качестве своего порта в настройках.

16. Далее мы запрограммируем ESP8266. Подключите USB-кабель между вашим ESP8266 и вашим компьютером.

Загрузите предоставленный файл New_BME_Sensor.ino в Arduino IDE. Ваш датчик BME280 должен быть подключен к D3 (SDA) и D4 (SCL) на ESP8266. Введите свой "ESP8266-NodeMCU-12E-BME280" (первый созданный вами канал), "Ключ записи", "SSID беспроводной сети" и "Пароль" в правильный раздел эскиза. Затем нажмите пункт меню "Эскиз" и "Загрузить". После загрузки эскиза (прогресс достигает 100%) на устройство ESP8266 вы можете открыть последовательный монитор (значок вверху справа выглядит как увеличительное стекло) и просматривать распечатку ваших данных через 5 минут, каждые 5 минут. Данные отправляются на thingspeak с интервалом в 5 минут, так что пройдет некоторое время, прежде чем у вас появятся значимые данные графика, но через 5 минут вы должны получить показания датчика.

Убедитесь, что вы получили правильные показания BME280 на последовательном мониторе.

Первое измерение, скорее всего, будет неверным nan.

### Подождите несколько минут до следующего считывания и убедитесь, что показания выглядят нормально.

17. Теперь, пока данные медленно загружаются в thingspeak, давайте сделаем некоторые настройки, чтобы получить некоторые дополнительные данные из того, что загружается. Вернитесь на веб-сайт thingspeak и на странице канала Thingspeak "BME280 Daily High Low Data" (второй созданный вами канал) нажмите зеленую кнопку "Анализ MATLAB". Выберите шаблон "Пользовательский (без начального кода)"

18. Назовите анализ MATLAB "Вычислять минимальное максимальное значение с полуночи".

19. Скопируйте MATLAB Analysis.txt код в предоставленное место. Введите "идентификатор канала" для "ESP8266-NodeMCU-12E-BME280" (первый созданный вами канал) в поле "readChannelID". Введите "Ежедневные максимальные и минимальные данные BME280" (второй созданный вами канал) Введите "Идентификатор канала" и "Ключ записи" в writeNewChannelID и writeAPIKey соответственно. Я знаю, это звучит запутанно (прочтите еще раз). Нажмите сохранить и запустить. Если вы все сделали правильно и канал чтения общедоступен, вы не увидите ошибок и он успешно напечатает значения. Обратите внимание, вы можете увидеть сообщение об ошибке, если на этот канал еще не были загружены данные. Несмотря на ошибку, продолжайте. При желании вы можете повторно нажать "Сохранить" и "Запустить", чтобы убедиться, что это работает после загрузки данных.

20. Далее нам нужно создать "Контроль времени" для запуска этого кода каждые 5 минут, и наши данные будут записаны в канал "BME280 Daily High Low Data" (второй созданный вами канал). На главной странице "BME280 Daily High Low Data" (второй созданный вами канал) выберите Приложения вверху. В разделе "Действия" выберите "TimeControl", затем зеленую кнопку "Новый TimeControl". Назовите это "Отправка высоких и низких значений температуры ESP8266". Выберите свой часовой пояс, если необходимо, и выберите "Повторяющийся" в разделе "Частота". Выберите "Минута" в разделе "Повторяемость". Установите для запуска каждые 5 минут. Действием должен быть анализ MATLAB, а "Код для выполнения" - "Вычислить минимальное максимальное значение с полуночи". Сохраните контроль времени.

Отредактируйте HTML-файлы и найдите комментарии, в которых говорится "******** Измените мне 1 из 8 *********" Измените их по своему усмотрению.

## Примечания:

Некоторые текстовые поля и недельный график не будут заполнены корректно, пока у вас не будет данных за полный день и неделю для раздела "24 часа и неделя" и графика.
Как только у вас будет куча данных, вы можете увеличить масштаб графиков с помощью колесика мыши (щелкните правой кнопкой мыши для сброса). Вы также можете использовать четвертый датчик (как показано на скриншотах) от другого датчика с другого канала, но я выделил соответствующие части. Если вы чувствуете себя уверенным, подключите его. Следует также учитывать некоторые временные проблемы. Скорее всего, у вас не будет самых последних данных, но они всегда должны быть меньше 5 минут назад. Это происходит при срабатывании регулятора синхронизации, когда данные были отправлены с ESP8266 и когда вы загрузили / обновили веб-страницу.

## Откройте предоставленный файл ESP8266-NodeMCU-12E-BME280.html в вашем веб-браузере, и вы увидите заполненные значения датчиков и график.
